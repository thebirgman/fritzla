{% comment %}
  Reviews Carousel Section â€” Infinite Loop + Pop-out Center
{% endcomment %}

<section 
  class="reviews-carousel section-{{ section.id }}"
  style="
    background: {{ section.settings.bg_color }};
    color: {{ section.settings.text_color }};
    padding: 60px 0;
  "
>
  <div class="page-width">
    {% if section.settings.heading != blank %}
      <h2 
        class="reviews-carousel__heading"
        style="font-size: {{ section.settings.font_size }}px; color: {{ section.settings.text_color }}"
      >
        {{ section.settings.heading }}
      </h2>
    {% endif %}

    <div class="reviews-carousel__wrapper">
      
      <!-- LEFT ARROW -->
      <button class="reviews-carousel__arrow left-arrow">
        <svg width="5" height="9" viewBox="0 0 5 9" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4.39003 4.38981L0.64045 8.1392C0.605612 8.17404 0.564254 8.20167 0.518737 8.22052C0.473219 8.23937 0.424434 8.24908 0.375167 8.24908C0.325899 8.24908 0.277114 8.23937 0.231596 8.22052C0.186079 8.20167 0.144721 8.17404 0.109884 8.1392C0.0750461 8.10436 0.0474116 8.06301 0.0285577 8.01749C0.0097038 7.97198 0 7.92319 0 7.87393C0 7.82466 0.0097038 7.77588 0.0285577 7.73037C0.0474116 7.68485 0.0750461 7.6435 0.109884 7.60866L3.59465 4.12454L0.109884 0.640417C0.0395262 0.570063 -7.41335e-10 0.474643 0 0.375148C7.41336e-10 0.275652 0.0395262 0.180232 0.109884 0.109878C0.180241 0.0395243 0.275666 7.41298e-10 0.375167 0C0.474667 -7.41298e-10 0.570092 0.0395243 0.64045 0.109878L4.39003 3.85927C4.42489 3.89409 4.45255 3.93544 4.47142 3.98096C4.49029 4.02648 4.5 4.07527 4.5 4.12454C4.5 4.17381 4.49029 4.2226 4.47142 4.26812C4.45255 4.31363 4.42489 4.35499 4.39003 4.38981Z" fill="#FAFAFA"/>
        </svg>
      </button>

      <div class="reviews-carousel__track-wrapper">
        <div class="reviews-carousel__track">

          {% for block in section.blocks %}
            <div 
              class="reviews-carousel__card"
              data-index="{{ forloop.index0 }}"
              style="
                background: {{ block.settings.card_bg }};
                color: {{ block.settings.card_text }};
              "
              {{ block.shopify_attributes }}
            >
              <div class="reviews-carousel__stars" style="color: {{ block.settings.star_color }}">
                <svg width="128" height="16" viewBox="0 0 128 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                {% comment %} (SVG of stars unchanged â€” not repeated here for space) {% endcomment %}
                </svg>
              </div>

              <p class="reviews-carousel__text">
                {{ block.settings.review_text }}
              </p>
            </div>
          {% endfor %}

        </div>
      </div>

      <!-- RIGHT ARROW -->
      <button class="reviews-carousel__arrow right-arrow">
        <svg width="5" height="9" viewBox="0 0 5 9" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4.39003 4.38981L0.64045 8.1392..." fill="#FAFAFA"/>
        </svg>
      </button>

    </div>
  </div>
</section>

<style>
/* ---------- GENERAL ---------- */
.reviews-carousel__heading {
  text-align: center;
  margin-bottom: 40px;
  font-weight: 700;
}

/* ---------- MAIN WRAPPER ---------- */
.reviews-carousel__wrapper {
  position: relative;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* ---------- ARROWS ---------- */
.reviews-carousel__arrow {
  background: #432F22;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  padding: 8px 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ---------- TRACK WRAPPER ---------- */
.reviews-carousel__track-wrapper {
  overflow-x: scroll;
  scrollbar-width: none;
  width: 100%;
}
.reviews-carousel__track-wrapper::-webkit-scrollbar { display:none; }

/* ---------- TRACK ---------- */
.reviews-carousel__track {
  display: flex;
  padding: 20px 0;
}

/* ---------- CARD ---------- */
.reviews-carousel__card {
  flex: 0 0 460px;
  background: white;
  padding: 40px 30px;
  border-radius: 18px;
  text-align: center;
  transition: transform .3s ease, opacity .3s ease, box-shadow .3s ease;
  transform: scale(.5);
  opacity: .4;
  box-shadow: 0 4px 20px rgba(0,0,0,.05);
}
.reviews-carousel__card.active {
  transform: scale(1);
  opacity: 1;
  box-shadow: 0 4px 20px rgba(0,0,0,.12);
}

/* ---------- MOBILE ---------- */
@media (max-width:768px) {
  .reviews-carousel__card { flex:0 0 230px; padding:20px 12px; }
  .reviews-carousel__text { font-size:12px; }
  .reviews-carousel__heading { font-size:24px!important; max-width:220px; margin:0 auto 24px; }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const section = document.querySelector('.section-{{ section.id }}');
  const wrapper = section.querySelector(".reviews-carousel__track-wrapper");
  const track = section.querySelector(".reviews-carousel__track");
  const leftArrow = section.querySelector(".left-arrow");
  const rightArrow = section.querySelector(".right-arrow");

  /** Collect originals */
  let cards = Array.from(track.children);
  const total = cards.length;

  if (!total) return;

  /** Disable snap */
  wrapper.style.scrollSnapType = "none";
  cards.forEach(c => c.style.scrollSnapAlign = "none");

  /** Get width dynamically */
  const getCardWidth = () =>
    cards[0].getBoundingClientRect().width;

  /** Clone cards */
  const clonesBefore = cards.map(c => {
    const clone = c.cloneNode(true);
    clone.classList.add("clone");
    track.prepend(clone);
    return clone;
  });
  const clonesAfter = cards.map(c => {
    const clone = c.cloneNode(true);
    clone.classList.add("clone");
    track.append(clone);
    return clone;
  });

  /** Refresh node list */
  cards = Array.from(track.children);

  let cardWidth = getCardWidth();
  let startOffset = cardWidth * total;

  /** ðŸŸ¢ FIXED CENTERING */
  const centerOnFirstRealCard = () => {
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        cardWidth = getCardWidth();
        startOffset = cardWidth * total;

        wrapper.scrollLeft =
          startOffset - wrapper.offsetWidth/2 + cardWidth/2;

        updateActiveCard();
      });
    });
  };

  centerOnFirstRealCard();

  /** Infinite loop logic */
  wrapper.addEventListener("scroll", () => {
    const left = wrapper.scrollLeft;
    const end = cardWidth * total * 2;

    if (left <= cardWidth) {
      wrapper.scrollLeft = left + cardWidth * total;
    }
    else if (left >= end - cardWidth) {
      wrapper.scrollLeft = left - cardWidth * total;
    }

    updateActiveCard();
  });

  /** Arrow scroll */
  const scrollNext = () =>
    wrapper.scrollBy({ left:getCardWidth(), behavior:"smooth" });

  const scrollPrev = () =>
    wrapper.scrollBy({ left:-getCardWidth(), behavior:"smooth" });

  rightArrow.addEventListener("click", scrollNext);
  leftArrow.addEventListener("click", scrollPrev);

  /** Active card update */
  function updateActiveCard() {
    const wrapperRect = wrapper.getBoundingClientRect();
    const centerX = wrapperRect.left + wrapperRect.width/2;

    let closest = null;
    let closestDist = Infinity;

    cards.forEach(card => {
      card.classList.remove("active");
      const rect = card.getBoundingClientRect();
      const dist = Math.abs(centerX - (rect.left + rect.width/2));
      if (dist < closestDist) { closestDist = dist; closest = card; }
    });

    if (closest) closest.classList.add("active");
  }

  /** Resize: recenter */
  window.addEventListener("resize", centerOnFirstRealCard);

});
</script>

{% schema %}
{
  "name": "Reviews Carousel",
  "settings": [
    { "type":"text","id":"heading","label":"Heading","default":"Detta sÃ¤ger vÃ¥ra kunder om oss!" },
    { "type":"color","id":"bg_color","label":"Background color","default":"#f7f2ed" },
    { "type":"color","id":"text_color","label":"Heading text color","default":"#3c2b20" },
    { "type":"range","id":"font_size","label":"Heading font size","min":16,"max":64,"step":1,"default":30 }
  ],
  "blocks": [
    {
      "type":"review",
      "name":"Review",
      "settings":[
        { "type":"color","id":"card_bg","label":"Card background","default":"#ffffff" },
        { "type":"color","id":"card_text","label":"Card text color","default":"#333333" },
        { "type":"color","id":"star_color","label":"Star color","default":"#d4a253" },
        { "type":"textarea","id":"review_text","label":"Review text","default":"Fantastiskt utbud av heminredning!" }
      ]
    }
  ],
  "presets":[{ "name":"Reviews Carousel (Infinite)" }]
}
{% endschema %}
