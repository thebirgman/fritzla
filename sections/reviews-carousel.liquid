{% comment %}
  Reviews Carousel Section — Infinite Loop + Pop-out Center
{% endcomment %}

<section 
  class="reviews-carousel section-{{ section.id }}"
  style="
    background: {{ section.settings.bg_color }};
    color: {{ section.settings.text_color }};
    padding: 60px 0;
  "
>
  <div class="page-width">
    {% if section.settings.heading != blank %}
      <h2 
        class="reviews-carousel__heading"
        style="font-size: {{ section.settings.font_size }}px; color: {{ section.settings.text_color }}"
      >
        {{ section.settings.heading }}
      </h2>
    {% endif %}

    <div class="reviews-carousel__wrapper">
      
      <!-- LEFT ARROW -->
      <button class="reviews-carousel__arrow left-arrow">
        <svg width="5" height="9" viewBox="0 0 5 9">
          <path d="M4.39 4.39L0.64 8.14c-.03.03-.07.06-.11.08-.05.02-.1.03-.15.03s-.1-.01-.15-.03a.54.54 0 0 1-.11-.08.52.52 0 0 1-.08-.12A.58.58 0 0 1 0 7.87c0-.05.01-.1.03-.15a.54.54 0 0 1 .08-.12L3.59 4.12.11.64A.52.52 0 0 1 0 .38C0 .28.04.18.11.11A.52.52 0 0 1 .38 0c.1 0 .2.04.27.11L4.39 3.86c.03.03.06.07.08.11.02.05.03.1.03.15s-.01.1-.03.15c-.02.04-.05.08-.08.12Z" fill="#FAFAFA"/>
        </svg>
      </button>

      <div class="reviews-carousel__track-wrapper">
        <div class="reviews-carousel__track">

          {% for block in section.blocks %}
            <div 
              class="reviews-carousel__card"
              data-index="{{ forloop.index0 }}"
              style="
                background: {{ block.settings.card_bg }};
                color: {{ block.settings.card_text }};
              "
              {{ block.shopify_attributes }}
            >
              <div class="reviews-carousel__stars" style="color: {{ block.settings.star_color }}">
                {% render 'stars-svg' %}
              </div>

              <p class="reviews-carousel__text">
                {{ block.settings.review_text }}
              </p>
            </div>
          {% endfor %}

        </div>
      </div>

      <!-- RIGHT ARROW -->
      <button class="reviews-carousel__arrow right-arrow">
        <svg width="5" height="9" viewBox="0 0 5 9">
          <path d="M4.39 4.39L0.64 8.14c-.03.03-.07.06-.11.08-.05.02-.1.03-.15.03s-.1-.01-.15-.03a.54.54 0 0 1-.11-.08.52.52 0 0 1-.08-.12A.58.58 0 0 1 0 7.87c0-.05.01-.1.03-.15a.54.54 0 0 1 .08-.12L3.59 4.12.11.64A.52.52 0 0 1 0 .38C0 .28.04.18.11.11A.52.52 0 0 1 .38 0c.1 0 .2.04.27.11L4.39 3.86c.03.03.06.07.08.11.02.05.03.1.03.15s-.01.1-.03.15c-.02.04-.05.08-.08.12Z" fill="#FAFAFA"/>
        </svg>
      </button>

    </div>
  </div>
</section>

<style>
/* ---------- GENERAL ---------- */
.reviews-carousel__heading {
  text-align: center;
  margin-bottom: 40px;
  font-weight: 700;
}

/* ---------- MAIN WRAPPER ---------- */
.reviews-carousel__wrapper {
  position: relative;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* ---------- ARROWS ---------- */
.reviews-carousel__arrow {
  background: #432F22;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  padding: 8px 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}

.left-arrow {
  transform: rotate(180deg);
}

/* ---------- TRACK WRAPPER ---------- */
.reviews-carousel__track-wrapper {
  overflow-x: scroll;
  scrollbar-width: none;
  width: 100%;
}
.reviews-carousel__track-wrapper::-webkit-scrollbar {
  display: none;
}

/* ---------- TRACK ---------- */
.reviews-carousel__track {
  display: flex;
  padding: 20px 0;
}

/* ---------- CARD ---------- */
.reviews-carousel__card {
  flex: 0 0 460px;
  background: white;
  padding: 40px 30px;
  border-radius: 18px;
  text-align: center;
  transition: transform 0.3s ease, opacity 0.3s ease;
  transform: scale(0.5);
  opacity: 0.4;
}

.reviews-carousel__card.active {
  transform: scale(1);
  opacity: 1;
}

/* ---------- STARS ---------- */
.reviews-carousel__stars {
  display: flex;
  justify-content: center;
  margin-bottom: 15px;
}

/* ---------- MOBILE ---------- */
@media (max-width: 768px) {
  .reviews-carousel__card {
    flex: 0 0 230px;
    padding: 20px 12px;
  }
  .reviews-carousel__text { font-size: 12px; }
  .reviews-carousel__heading {
    font-size: 24px !important;
    max-width: 220px;
    margin: 0 auto 24px;
    line-height: 120%;
  }
  .reviews-carousel { padding: 40px 0 !important; }
}

.reviews-carousel__text { line-height: 1.4; }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const section = document.querySelector('.section-{{ section.id }}');
  const wrapper = section.querySelector(".reviews-carousel__track-wrapper");
  const track = section.querySelector(".reviews-carousel__track");

  const leftArrow = section.querySelector(".left-arrow");
  const rightArrow = section.querySelector(".right-arrow");

  let cards = Array.from(track.children);
  const total = cards.length;
  if (total === 0) return;

  /* No scroll snap */
  wrapper.style.scrollSnapType = "none";
  cards.forEach(c => c.style.scrollSnapAlign = "none");

  /* Dynamic width */
  const getCardWidth = () => cards[0].getBoundingClientRect().width;

  /* Clone cards before/after */
  const clonesBefore = cards.map(c => {
    const clone = c.cloneNode(true);
    clone.classList.add("clone");
    track.prepend(clone);
    return clone;
  });

  const clonesAfter = cards.map(c => {
    const clone = c.cloneNode(true);
    clone.classList.add("clone");
    track.append(clone);
    return clone;
  });

  cards = Array.from(track.children);

  let cardWidth = getCardWidth();
  let startOffset = cardWidth * total;

  /* Centering function */
  const centerOnFirstRealCard = () => {
    cardWidth = getCardWidth();
    startOffset = cardWidth * total;
    wrapper.scrollLeft = startOffset - (wrapper.offsetWidth / 2) + (cardWidth / 2);
  };

  centerOnFirstRealCard();

  /* Infinite loop */
  wrapper.addEventListener("scroll", () => {
    const left = wrapper.scrollLeft;
    const end = cardWidth * total * 2;

    if (left <= cardWidth) {
      wrapper.scrollLeft = left + cardWidth * total;
    } else if (left >= end - cardWidth) {
      wrapper.scrollLeft = left - cardWidth * total;
    }

    updateActiveCard();
  });

  /* Arrows */
  rightArrow.addEventListener("click", () => {
    wrapper.scrollBy({ left: getCardWidth(), behavior: "smooth" });
  });

  leftArrow.addEventListener("click", () => {
    wrapper.scrollBy({ left: -getCardWidth(), behavior: "smooth" });
  });

  /* Active center card */
  function updateActiveCard() {
    const wrapperRect = wrapper.getBoundingClientRect();
    const centerX = wrapperRect.left + wrapperRect.width / 2;

    let closest = null;
    let closestDist = Infinity;

    cards.forEach(card => {
      card.classList.remove("active");
      const rect = card.getBoundingClientRect();
      const dist = Math.abs(centerX - (rect.left + rect.width / 2));
      if (dist < closestDist) {
        closestDist = dist;
        closest = card;
      }
    });

    if (closest) closest.classList.add("active");
  }

  updateActiveCard();

  /* Recenter on resize */
  window.addEventListener("resize", () => {
    centerOnFirstRealCard();
    updateActiveCard();
  });
});
</script>

{% schema %}
{
  "name": "Reviews Carousel",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Detta säger våra kunder om oss!"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#f7f2ed"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Heading text color",
      "default": "#3c2b20"
    },
    {
      "type": "range",
      "id": "font_size",
      "label": "Heading font size",
      "min": 16,
      "max": 64,
      "step": 1,
      "default": 30
    }
  ],
  "blocks": [
    {
      "type": "review",
      "name": "Review",
      "settings": [
        { "type": "color", "id": "card_bg", "label": "Card background", "default": "#ffffff" },
        { "type": "color", "id": "card_text", "label": "Card text color", "default": "#333333" },
        { "type": "color", "id": "star_color", "label": "Star color", "default": "#d4a253" },
        { "type": "textarea", "id": "review_text", "label": "Review text", "default": "Fantastiskt utbud av heminredning!" }
      ]
    }
  ],
  "presets": [
    { "name": "Reviews Carousel (Infinite)" }
  ]
}
{% endschema %}
