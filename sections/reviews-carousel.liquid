{% comment %}
  Reviews Carousel Section — Infinite Loop
{% endcomment %}

<section 
  class="reviews-carousel section-{{ section.id }}"
  style="
    background: {{ section.settings.bg_color }};
    color: {{ section.settings.text_color }};
    padding: 60px 0;
  "
>
  <div class="page-width">
    {% if section.settings.heading != blank %}
      <h2 
        class="reviews-carousel__heading"
        style="font-size: {{ section.settings.font_size }}px; color: {{ section.settings.text_color }}"
      >
        {{ section.settings.heading }}
      </h2>
    {% endif %}

    <div class="reviews-carousel__wrapper">
      
      <!-- LEFT ARROW -->
      <button class="reviews-carousel__arrow left-arrow">
        <!-- INSERT LEFT ARROW SVG -->
      </button>

      <!-- Track wrapper -->
      <div class="reviews-carousel__track-wrapper">
        <div class="reviews-carousel__track">

          {% comment %} REAL CARDS {% endcomment %}
          {% for block in section.blocks %}
            <div 
              class="reviews-carousel__card"
              data-index="{{ forloop.index0 }}"
              style="
                background: {{ block.settings.card_bg }};
                color: {{ block.settings.card_text }};
              "
              {{ block.shopify_attributes }}
            >
              <div class="reviews-carousel__stars" style="color: {{ block.settings.star_color }}">
                <!-- STAR SVGs -->
              </div>

              <p class="reviews-carousel__text">
                {{ block.settings.review_text }}
              </p>
            </div>
          {% endfor %}

        </div>
      </div>

      <!-- RIGHT ARROW -->
      <button class="reviews-carousel__arrow right-arrow">
        <!-- INSERT RIGHT ARROW SVG -->
      </button>

    </div>
  </div>
</section>


<style>
.reviews-carousel__heading {
  text-align: center;
  margin-bottom: 40px;
}

.reviews-carousel__wrapper {
  position: relative;
  display: flex;
  align-items: center;
}

.reviews-carousel__arrow {
  background: none;
  border: none;
  cursor: pointer;
  padding: 12px;
  z-index: 10;
}

.reviews-carousel__track-wrapper {
  overflow-x: scroll;
  scroll-snap-type: x mandatory;
  scrollbar-width: none;
  width: 100%;
}

.reviews-carousel__track-wrapper::-webkit-scrollbar {
  display: none;
}

.reviews-carousel__track {
  display: flex;
  gap: 20px;
  padding: 20px 0;
}

.reviews-carousel__card {
  flex: 0 0 460px;
  padding: 25px 30px;
  border-radius: 16px;
  scroll-snap-align: center;
  transition: transform 0.3s ease, opacity 0.3s ease, box-shadow 0.3s ease;
  transform: scale(0.55);
  opacity: 0.4;
  box-shadow: 0 4px 20px rgba(0,0,0,0.05);
}

.reviews-carousel__card.active {
  transform: scale(1);
  opacity: 1;
  box-shadow: 0 8px 30px rgba(0,0,0,0.12);
}

.reviews-carousel__stars {
  display: flex;
  justify-content: center;
  margin-bottom: 15px;
}

.reviews-carousel__text {
  text-align: center;
}
</style>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const section = document.querySelector('.section-{{ section.id }}');
  const wrapper = section.querySelector(".reviews-carousel__track-wrapper");
  const track = section.querySelector(".reviews-carousel__track");
  const cards = Array.from(track.children);

  const leftArrow = section.querySelector(".left-arrow");
  const rightArrow = section.querySelector(".right-arrow");

  const cardWidth = cards[0].offsetWidth + 20; // includes gap
  const total = cards.length;

  /* -----------------------------
    1. Clone edges for infinite loop
  ------------------------------ */
  const startClones = cards.slice(-3).map(c => c.cloneNode(true));
  const endClones = cards.slice(0, 3).map(c => c.cloneNode(true));

  startClones.forEach(clone => {
    clone.classList.add("clone");
    track.insertBefore(clone, track.firstChild);
  });

  endClones.forEach(clone => {
    clone.classList.add("clone");
    track.appendChild(clone);
  });

  /* Starting scroll position = after first 3 clones */
  wrapper.scrollLeft = cardWidth * 3;


  /* -----------------------------
    2. Infinite Loop Scroll Logic
  ------------------------------ */
  wrapper.addEventListener("scroll", () => {
    const maxScroll = cardWidth * (total + 3);
    const minScroll = cardWidth * 2;

    // Passed end → jump back to start
    if (wrapper.scrollLeft >= maxScroll) {
      wrapper.scrollLeft = cardWidth * 3;
    }

    // Passed start → jump to end
    if (wrapper.scrollLeft <= minScroll) {
      wrapper.scrollLeft = cardWidth * (total + 2);
    }

    updateActiveCard();
  });


  /* -----------------------------
    3. Arrow Controls
  ------------------------------ */
  const scrollAmount = cardWidth;

  if (rightArrow) {
    rightArrow.addEventListener("click", () => {
      wrapper.scrollBy({ left: scrollAmount, behavior: "smooth" });
    });
  }

  if (leftArrow) {
    leftArrow.addEventListener("click", () => {
      wrapper.scrollBy({ left: -scrollAmount, behavior: "smooth" });
    });
  }


  /* -----------------------------
    4. Determine Active (Center) Card
  ------------------------------ */
  function updateActiveCard() {
    const wrapperRect = wrapper.getBoundingClientRect();
    const centerX = wrapperRect.left + wrapperRect.width / 2;

    const allCards = section.querySelectorAll(".reviews-carousel__card");

    let closest = null;
    let closestDist = Infinity;

    allCards.forEach(card => {
      const rect = card.getBoundingClientRect();
      const cardCenter = rect.left + rect.width / 2;
      const dist = Math.abs(centerX - cardCenter);

      card.classList.remove("active");

      if (dist < closestDist) {
        closestDist = dist;
        closest = card;
      }
    });

    if (closest) closest.classList.add("active");
  }

  updateActiveCard();
  window.addEventListener("resize", updateActiveCard);
});
</script>
