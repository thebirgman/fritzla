{% comment %}
  Reviews Carousel Section — Infinite Loop + Pop-out Center
{% endcomment %}

<section 
  class="reviews-carousel section-{{ section.id }}"
  style="
    background: {{ section.settings.bg_color }};
    color: {{ section.settings.text_color }};
    padding: 60px 0;
  "
>
  <div class="page-width">
    {% if section.settings.heading != blank %}
      <h2 
        class="reviews-carousel__heading"
        style="font-size: {{ section.settings.font_size }}px; color: {{ section.settings.text_color }}"
      >
        {{ section.settings.heading }}
      </h2>
    {% endif %}

    <div class="reviews-carousel__wrapper">
      
      <!-- LEFT ARROW -->
      <button class="reviews-carousel__arrow left-arrow">
        <svg width="5" height="9" viewBox="0 0 5 9" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4.39003 4.38981L0.64045 8.1392C0.605612 8.17404 0.564254 8.20167 0.518737 8.22052C0.473219 8.23937 0.424434 8.24908 0.375167 8.24908C0.325899 8.24908 0.277114 8.23937 0.231596 8.22052C0.186079 8.20167 0.144721 8.17404 0.109884 8.1392C0.0750461 8.10436 0.0474116 8.06301 0.0285577 8.01749C0.0097038 7.97198 0 7.92319 0 7.87393C0 7.82466 0.0097038 7.77588 0.0285577 7.73037C0.0474116 7.68485 0.0750461 7.6435 0.109884 7.60866L3.59465 4.12454L0.109884 0.640417C0.0395262 0.570063 -7.41335e-10 0.474643 0 0.375148C7.41336e-10 0.275652 0.0395262 0.180232 0.109884 0.109878C0.180241 0.0395243 0.275666 7.41298e-10 0.375167 0C0.474667 -7.41298e-10 0.570092 0.0395243 0.64045 0.109878L4.39003 3.85927C4.42489 3.89409 4.45255 3.93544 4.47142 3.98096C4.49029 4.02648 4.5 4.07527 4.5 4.12454C4.5 4.17381 4.49029 4.2226 4.47142 4.26812C4.45255 4.31363 4.42489 4.35499 4.39003 4.38981Z" fill="#FAFAFA"/>
        </svg>
      </button>

      <div class="reviews-carousel__track-wrapper">
        <div class="reviews-carousel__track">

          {% for block in section.blocks %}
            <div 
              class="reviews-carousel__card"
              data-index="{{ forloop.index0 }}"
              style="
                background: {{ block.settings.card_bg }};
                color: {{ block.settings.card_text }};
              "
              {{ block.shopify_attributes }}
            >
              <div class="reviews-carousel__stars" style="color: {{ block.settings.star_color }}">
                <svg width="128" height="16" viewBox="0 0 128 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15.5967 7.32255L12.3805 10.1993L13.3604 14.5015C13.4145 14.735 13.4005 14.9799 13.3204 15.2053C13.2402 15.4306 13.0975 15.6263 12.9101 15.7676C12.7227 15.9089 12.4992 15.9894 12.2677 15.999C12.0361 16.0087 11.8071 15.9469 11.6094 15.8217L8.00014 13.5191L4.38876 15.8217C4.19109 15.9462 3.9623 16.0073 3.73119 15.9974C3.50008 15.9874 3.27699 15.9067 3.09 15.7656C2.90302 15.6244 2.76051 15.4291 2.68041 15.2041C2.60031 14.9792 2.58621 14.7347 2.63988 14.5015L3.62331 10.1993L0.407157 7.32255C0.232268 7.16587 0.105785 6.95925 0.043504 6.72849C-0.0187769 6.49774 -0.0140954 6.25308 0.0569637 6.02506C0.128023 5.79705 0.26231 5.59579 0.443055 5.44642C0.6238 5.29705 0.842993 5.20618 1.07326 5.18517L5.29 4.83252L6.91666 0.751869C7.0047 0.529476 7.15456 0.339247 7.34717 0.205366C7.53978 0.0714847 7.76645 0 7.99836 0C8.23026 0 8.45693 0.0714847 8.64954 0.205366C8.84215 0.339247 8.99201 0.529476 9.08006 0.751869L10.706 4.83252L14.9227 5.18517C15.1535 5.2054 15.3733 5.29576 15.5547 5.44492C15.7361 5.59409 15.871 5.79543 15.9425 6.02372C16.014 6.25201 16.0189 6.4971 15.9567 6.72827C15.8944 6.95945 15.7677 7.16643 15.5924 7.32329L15.5967 7.32255Z" fill="#CB9D36"/>
                <path d="M43.5967 7.32255L40.3805 10.1993L41.3604 14.5015C41.4145 14.735 41.4005 14.9799 41.3204 15.2053C41.2402 15.4306 41.0975 15.6263 40.9101 15.7676C40.7227 15.9089 40.4992 15.9894 40.2677 15.999C40.0361 16.0087 39.8071 15.9469 39.6094 15.8217L36.0001 13.5191L32.3888 15.8217C32.1911 15.9462 31.9623 16.0073 31.7312 15.9974C31.5001 15.9874 31.277 15.9067 31.09 15.7656C30.903 15.6244 30.7605 15.4291 30.6804 15.2041C30.6003 14.9792 30.5862 14.7347 30.6399 14.5015L31.6233 10.1993L28.4072 7.32255C28.2323 7.16587 28.1058 6.95925 28.0435 6.72849C27.9812 6.49774 27.9859 6.25308 28.057 6.02506C28.128 5.79705 28.2623 5.59579 28.4431 5.44642C28.6238 5.29705 28.843 5.20618 29.0733 5.18517L33.29 4.83252L34.9167 0.751869C35.0047 0.529476 35.1546 0.339247 35.3472 0.205366C35.5398 0.0714847 35.7665 0 35.9984 0C36.2303 0 36.4569 0.0714847 36.6495 0.205366C36.8422 0.339247 36.992 0.529476 37.0801 0.751869L38.706 4.83252L42.9227 5.18517C43.1535 5.2054 43.3733 5.29576 43.5547 5.44492C43.7361 5.59409 43.871 5.79543 43.9425 6.02372C44.014 6.25201 44.0189 6.4971 43.9567 6.72827C43.8944 6.95945 43.7677 7.16643 43.5924 7.32329L43.5967 7.32255Z" fill="#CB9D36"/>
                <path d="M71.5967 7.32255L68.3805 10.1993L69.3604 14.5015C69.4145 14.735 69.4005 14.9799 69.3204 15.2053C69.2402 15.4306 69.0975 15.6263 68.9101 15.7676C68.7227 15.9089 68.4992 15.9894 68.2677 15.999C68.0361 16.0087 67.8071 15.9469 67.6094 15.8217L64.0001 13.5191L60.3888 15.8217C60.1911 15.9462 59.9623 16.0073 59.7312 15.9974C59.5001 15.9874 59.277 15.9067 59.09 15.7656C58.903 15.6244 58.7605 15.4291 58.6804 15.2041C58.6003 14.9792 58.5862 14.7347 58.6399 14.5015L59.6233 10.1993L56.4072 7.32255C56.2323 7.16587 56.1058 6.95925 56.0435 6.72849C55.9812 6.49774 55.9859 6.25308 56.057 6.02506C56.128 5.79705 56.2623 5.59579 56.4431 5.44642C56.6238 5.29705 56.843 5.20618 57.0733 5.18517L61.29 4.83252L62.9167 0.751869C63.0047 0.529476 63.1546 0.339247 63.3472 0.205366C63.5398 0.0714847 63.7665 0 63.9984 0C64.2303 0 64.4569 0.0714847 64.6495 0.205366C64.8422 0.339247 64.992 0.529476 65.0801 0.751869L66.706 4.83252L70.9227 5.18517C71.1535 5.2054 71.3733 5.29576 71.5547 5.44492C71.7361 5.59409 71.871 5.79543 71.9425 6.02372C72.014 6.25201 72.0189 6.4971 71.9567 6.72827C71.8944 6.95945 71.7677 7.16643 71.5924 7.32329L71.5967 7.32255Z" fill="#CB9D36"/>
                <path d="M99.5967 7.32255L96.3805 10.1993L97.3604 14.5015C97.4145 14.735 97.4005 14.9799 97.3204 15.2053C97.2402 15.4306 97.0975 15.6263 96.9101 15.7676C96.7227 15.9089 96.4992 15.9894 96.2677 15.999C96.0361 16.0087 95.8071 15.9469 95.6094 15.8217L92.0001 13.5191L88.3888 15.8217C88.1911 15.9462 87.9623 16.0073 87.7312 15.9974C87.5001 15.9874 87.277 15.9067 87.09 15.7656C86.903 15.6244 86.7605 15.4291 86.6804 15.2041C86.6003 14.9792 86.5862 14.7347 86.6399 14.5015L87.6233 10.1993L84.4072 7.32255C84.2323 7.16587 84.1058 6.95925 84.0435 6.72849C83.9812 6.49774 83.9859 6.25308 84.057 6.02506C84.128 5.79705 84.2623 5.59579 84.4431 5.44642C84.6238 5.29705 84.843 5.20618 85.0733 5.18517L89.29 4.83252L90.9167 0.751869C91.0047 0.529476 91.1546 0.339247 91.3472 0.205366C91.5398 0.0714847 91.7665 0 91.9984 0C92.2303 0 92.4569 0.0714847 92.6495 0.205366C92.8422 0.339247 92.992 0.529476 93.0801 0.751869L94.706 4.83252L98.9227 5.18517C99.1535 5.2054 99.3733 5.29576 99.5547 5.44492C99.7361 5.59409 99.871 5.79543 99.9425 6.02372C100.014 6.25201 100.019 6.4971 99.9567 6.72827C99.8944 6.95945 99.7677 7.16643 99.5924 7.32329L99.5967 7.32255Z" fill="#CB9D36"/>
                <path d="M127.597 7.32255L124.381 10.1993L125.36 14.5015C125.414 14.735 125.401 14.9799 125.32 15.2053C125.24 15.4306 125.097 15.6263 124.91 15.7676C124.723 15.9089 124.499 15.9894 124.268 15.999C124.036 16.0087 123.807 15.9469 123.609 15.8217L120 13.5191L116.389 15.8217C116.191 15.9462 115.962 16.0073 115.731 15.9974C115.5 15.9874 115.277 15.9067 115.09 15.7656C114.903 15.6244 114.761 15.4291 114.68 15.2041C114.6 14.9792 114.586 14.7347 114.64 14.5015L115.623 10.1993L112.407 7.32255C112.232 7.16587 112.106 6.95925 112.044 6.72849C111.981 6.49774 111.986 6.25308 112.057 6.02506C112.128 5.79705 112.262 5.59579 112.443 5.44642C112.624 5.29705 112.843 5.20618 113.073 5.18517L117.29 4.83252L118.917 0.751869C119.005 0.529476 119.155 0.339247 119.347 0.205366C119.54 0.0714847 119.766 0 119.998 0C120.23 0 120.457 0.0714847 120.65 0.205366C120.842 0.339247 120.992 0.529476 121.08 0.751869L122.706 4.83252L126.923 5.18517C127.153 5.2054 127.373 5.29576 127.555 5.44492C127.736 5.59409 127.871 5.79543 127.943 6.02372C128.014 6.25201 128.019 6.4971 127.957 6.72827C127.894 6.95945 127.768 7.16643 127.592 7.32329L127.597 7.32255Z" fill="#CB9D36"/>
                </svg>
              </div>

              <p class="reviews-carousel__text">
                {{ block.settings.review_text }}
              </p>
            </div>
          {% endfor %}

        </div>
      </div>

      <!-- RIGHT ARROW -->
      <button class="reviews-carousel__arrow right-arrow">
        <svg width="5" height="9" viewBox="0 0 5 9" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4.39003 4.38981L0.64045 8.1392C0.605612 8.17404 0.564254 8.20167 0.518737 8.22052C0.473219 8.23937 0.424434 8.24908 0.375167 8.24908C0.325899 8.24908 0.277114 8.23937 0.231596 8.22052C0.186079 8.20167 0.144721 8.17404 0.109884 8.1392C0.0750461 8.10436 0.0474116 8.06301 0.0285577 8.01749C0.0097038 7.97198 0 7.92319 0 7.87393C0 7.82466 0.0097038 7.77588 0.0285577 7.73037C0.0474116 7.68485 0.0750461 7.6435 0.109884 7.60866L3.59465 4.12454L0.109884 0.640417C0.0395262 0.570063 -7.41335e-10 0.474643 0 0.375148C7.41336e-10 0.275652 0.0395262 0.180232 0.109884 0.109878C0.180241 0.0395243 0.275666 7.41298e-10 0.375167 0C0.474667 -7.41298e-10 0.570092 0.0395243 0.64045 0.109878L4.39003 3.85927C4.42489 3.89409 4.45255 3.93544 4.47142 3.98096C4.49029 4.02648 4.5 4.07527 4.5 4.12454C4.5 4.17381 4.49029 4.2226 4.47142 4.26812C4.45255 4.31363 4.42489 4.35499 4.39003 4.38981Z" fill="#FAFAFA"/>
        </svg>
      </button>

    </div>
  </div>
</section>

<style>
/* ---------- GENERAL ---------- */
.reviews-carousel__heading {
  text-align: center;
  margin-bottom: 40px;
}

/* ---------- MAIN WRAPPER ---------- */
.reviews-carousel__wrapper {
  position: relative;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* ---------- ARROWS ---------- */
.reviews-carousel__arrow {
  background: none;
  border: none;
  cursor: pointer;
  padding: 12px;
  z-index: 10;
}

/* ---------- TRACK WRAPPER ---------- */
.reviews-carousel__track-wrapper {
  overflow-x: scroll;
  scroll-snap-type: x mandatory;
  scrollbar-width: none;
  width: 100%;
}

.reviews-carousel__track-wrapper::-webkit-scrollbar {
  display: none;
}

/* ---------- TRACK ---------- */
.reviews-carousel__track {
  display: flex;
  gap: 20px;
  padding: 20px 0;
}

/* ---------- CARD ---------- */
.reviews-carousel__card {
  flex: 0 0 320px;
  background: white;
  padding: 25px 30px;
  border-radius: 18px;
  scroll-snap-align: center;
  text-align: center;
  transition: 
    transform 0.3s ease,
    opacity 0.3s ease,
    box-shadow 0.3s ease;
  
  transform: scale(0.85);
  opacity: 0.4;
  box-shadow: 0 4px 20px rgba(0,0,0,0.05);
}

.reviews-carousel__card.active {
  transform: scale(1);
  opacity: 1;
  box-shadow: 0 8px 30px rgba(0,0,0,0.12);
}

/* Stars */
.reviews-carousel__stars {
  display: flex;
  justify-content: center;
  margin-bottom: 15px;
}

.reviews-carousel__text {
  line-height: 1.4;
}
</style>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const section = document.querySelector('.section-{{ section.id }}');
  const wrapper = section.querySelector(".reviews-carousel__track-wrapper");
  const track = section.querySelector(".reviews-carousel__track");

  const leftArrow = section.querySelector(".left-arrow");
  const rightArrow = section.querySelector(".right-arrow");

  let cards = Array.from(track.children);
  const total = cards.length;

  if (total === 0) return;

  const gap = 20; // gap in CSS
  const cardWidth = cards[0].offsetWidth + gap;

  /* ------------------------------------------------------------------
     1. CLONE CARDS AT START AND END FOR INFINITE LOOP
  ------------------------------------------------------------------ */
  const cloneCount = 3; // safe amount
  const clonesStart = cards.slice(-cloneCount).map(c => c.cloneNode(true));
  const clonesEnd = cards.slice(0, cloneCount).map(c => c.cloneNode(true));

  clonesStart.forEach(c => {
    c.classList.add("clone");
    track.insertBefore(c, track.firstChild);
  });

  clonesEnd.forEach(c => {
    c.classList.add("clone");
    track.appendChild(c);
  });

  // recalc after clones
  cards = Array.from(track.children);

  // START POSITION = after the leading clones
  wrapper.scrollLeft = cardWidth * cloneCount;


  /* ------------------------------------------------------------------
     2. INFINITE LOOP TELEPORT LOGIC
  ------------------------------------------------------------------ */
  wrapper.addEventListener("scroll", () => {
    const maxScroll = cardWidth * (total + cloneCount);
    const minScroll = cardWidth * (cloneCount - 1);

    if (wrapper.scrollLeft >= maxScroll) {
      wrapper.scrollLeft = cardWidth * cloneCount;
    }

    if (wrapper.scrollLeft <= minScroll) {
      wrapper.scrollLeft = cardWidth * (total + cloneCount - 1);
    }

    updateActiveCard();
  });


  /* ------------------------------------------------------------------
     3. ARROW SCROLLING
  ------------------------------------------------------------------ */
  const scrollAmount = cardWidth;

  if (rightArrow) {
    rightArrow.addEventListener("click", () => {
      wrapper.scrollBy({ left: scrollAmount, behavior: "smooth" });
    });
  }

  if (leftArrow) {
    leftArrow.addEventListener("click", () => {
      wrapper.scrollBy({ left: -scrollAmount, behavior: "smooth" });
    });
  }


  /* ------------------------------------------------------------------
     4. DETECT CENTER CARD & APPLY ACTIVE STYLE
  ------------------------------------------------------------------ */
  function updateActiveCard() {
    const wrapperRect = wrapper.getBoundingClientRect();
    const centerX = wrapperRect.left + wrapperRect.width / 2;

    let closest = null;
    let closestDist = Infinity;

    cards.forEach(card => {
      const rect = card.getBoundingClientRect();
      const cardCenter = rect.left + rect.width / 2;
      const dist = Math.abs(centerX - cardCenter);

      card.classList.remove("active");

      if (dist < closestDist) {
        closestDist = dist;
        closest = card;
      }
    });

    if (closest) closest.classList.add("active");
  }

  updateActiveCard();
  window.addEventListener("resize", updateActiveCard);
});
</script>



{% schema %}
{
  "name": "Reviews Carousel",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Detta säger våra kunder om oss!"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#f7f2ed"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Heading text color",
      "default": "#3c2b20"
    },
    {
      "type": "range",
      "id": "font_size",
      "label": "Heading font size",
      "min": 16,
      "max": 64,
      "step": 1,
      "default": 30
    }
  ],
  "blocks": [
    {
      "type": "review",
      "name": "Review",
      "settings": [
        {
          "type": "color",
          "id": "card_bg",
          "label": "Card background",
          "default": "#ffffff"
        },
        {
          "type": "color",
          "id": "card_text",
          "label": "Card text color",
          "default": "#333333"
        },
        {
          "type": "color",
          "id": "star_color",
          "label": "Star color",
          "default": "#d4a253"
        },
        {
          "type": "textarea",
          "id": "review_text",
          "label": "Review text",
          "default": "Fantastiskt utbud av heminredning!"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Reviews Carousel (Infinite)"
    }
  ]
}
{% endschema %}
